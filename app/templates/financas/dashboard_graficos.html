{% extends 'layout.html' %}

{% block title %}Relatórios de Gastos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="h3 mb-4">Relatórios de Gastos</h1>

    <div class="card shadow-sm rounded-lg mb-4 border-0">
        <div class="card-body">
            <form method="GET" action="{{ url_for('financas.dashboard_graficos') }}" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="mes" class="form-label">Mês</label>
                    <select name="mes" id="mes" class="form-select rounded-pill">
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == mes_filtro %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="ano" class="form-label">Ano</label>
                    <select name="ano" id="ano" class="form-select rounded-pill">
                        {% set anos_dados = meses_com_dados|map(attribute='ano')|unique|list %}
                        {% if not anos_dados %}{% set anos_dados = range(2024, 2031) %}{% endif %}
                        {% for a in anos_dados|sort(reverse=True) %}
                        <option value="{{ a }}" {% if a == ano_filtro %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-dark rounded-pill">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm rounded-lg h-100 border-0">
                <div class="card-header">
                    <h2 class="h6 mb-0">Gastos por Categoria ({{ mes_filtro }}/{{ ano_filtro }})</h2>
                </div>
                <div class="card-body p-0">
                    {% if dados_categoria.data %}
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Valor Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(dados_categoria.labels|length) %}
                            <tr>
                                <td>{{ dados_categoria.labels[i] }}</td>
                                <td>{{ "%.2f"|format(dados_categoria.data[i]) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-muted p-4">Nenhum dado de gasto variável encontrado para este período.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm rounded-lg h-100 border-0">
                <div class="card-header">
                    <h2 class="h6 mb-0">Histórico de Gasto Total (Geral)</h2>
                </div>
                <div class="card-body p-0">
                    {% if dados_historico.data %}
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Gasto Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(dados_historico.labels|length - 1, -1, -1) %}
                            <tr>
                                <td>{{ dados_historico.labels[i] }}</td>
                                <td>{{ "%.2f"|format(dados_historico.data[i]) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-muted p-4">Nenhum mês fechado para exibir o histórico.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}