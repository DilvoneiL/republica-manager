{% extends "layout.html" %}

{% block title %}Gerenciar Usuários{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Gerenciar Usuários</h1>
    <a href="{{ url_for('admin.criar_usuario') }}" class="btn btn-primary">Adicionar Novo Usuário</a>
</div>
{% if current_user.is_admin() %}
  <a href="{{ url_for('admin.adicionar_saldo_caixinha_manual') }}">Adicionar Saldo Caixinha</a>
{% endif %}
<!-- Seção para mostrar mensagens de feedback (flashed messages) -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Nome de Usuário</th>
                <th scope="col">Cargo</th>
                <th scope="col">Tipo Quarto</th>
                <th scope="col" class="text-end">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for user in usuarios %}
            <tr class="align-middle">
                <th scope="row">{{ user.id }}</th>
                <td>{{ user.username }}</td>
                <td>{{ user.cargo.capitalize() }}</td>
                <td>{{ user.tipo_quarto }}</td>
                <td class="text-end">
                    <!-- Botão Editar (visível para Gerentes e Admins) -->
                    <a href="{{ url_for('admin.edit_usuario', user_id=user.id) }}" class="btn btn-secondary btn-sm">Editar</a>
                    
                    <!-- Botão Remover (visível APENAS para Admins) -->
                    {% if current_user.is_admin() %}
                    <button type="button" class="btn btn-danger btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#confirmDeleteModal"
                            data-user-id="{{ user.id }}"
                            data-user-name="{{ user.username }}">
                        Remover
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="text-center">Nenhum usuário encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Janela de Confirmação (Modal) para Exclusão -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Remoção</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja remover o usuário <strong id="userNameInModal"></strong>? Esta ação não pode ser desfeita.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="deleteForm" method="POST" action="">
            <button type="submit" class="btn btn-danger">Confirmar Remoção</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Script para passar os dados do usuário para a janela de confirmação
    var confirmDeleteModal = document.getElementById('confirmDeleteModal');
    confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
        // Botão que ativou o modal
        var button = event.relatedTarget;
        
        // Extrai as informações dos atributos data-*
        var userId = button.getAttribute('data-user-id');
        var userName = button.getAttribute('data-user-name');
        
        // Atualiza o conteúdo do modal
        var modalBodyStrong = confirmDeleteModal.querySelector('#userNameInModal');
        modalBodyStrong.textContent = userName;
        
        // Atualiza o action do formulário de deleção
        var deleteForm = confirmDeleteModal.querySelector('#deleteForm');
        deleteForm.action = '/admin/usuarios/deletar/' + userId;
    });
</script>
{% endblock %}

